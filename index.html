<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>James Weather Tracker</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body { margin:0; font-family: system-ui,sans-serif; background:#0b1220; color:#e6eef8; }
  header { padding:14px 20px; display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.03); }
  a { color:#60a5fa; text-decoration:none; }
  main { padding: 10px 20px; display:flex; flex-direction:column; gap:20px; }
  .current-weather, .forecast, .info-cards, #map { background:rgba(255,255,255,0.03); padding:10px; border-radius:8px; }
  .forecast { display:flex; gap:10px; overflow-x:auto; }
  .forecast-day { flex:0 0 100px; text-align:center; padding:5px; border-radius:6px; background:rgba(255,255,255,0.05); }
  .info-cards { display:flex; gap:10px; flex-wrap:wrap; }
  .card { flex:1; min-width:150px; padding:8px; border-radius:6px; background:rgba(255,255,255,0.05); text-align:center; }
  #map { height:300px; border-radius:8px; }
  .toggle { cursor:pointer; margin-left:10px; }
</style>
</head>
<body>
<header>
  <div><strong>🌦 James Weather Tracker</strong></div>
  <div>
    <input type="text" id="cityInput" placeholder="Enter city..." />
    <button id="searchBtn">Search</button>
    <span class="toggle" id="unitToggle">°C/°F</span>
  </div>
</header>
<main>
  <div class="current-weather" id="currentWeather"></div>
  <div class="forecast" id="forecast"></div>
  <div class="info-cards">
    <div class="card" id="sunMoonCard"></div>
    <div class="card" id="aqiCard"></div>
  </div>
  <div id="map"></div>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ===== Global Variables =====
let lastData = null;
let unitC = true;
const unitToggle = document.getElementById('unitToggle');
unitToggle.addEventListener('click', () => {
  unitC = !unitC;
  if(lastData) updateDisplay(lastData);
});

// ===== Initialize Leaflet Map =====
const map = L.map('map').setView([39.8283, -98.5795], 4); // USA center
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// ===== Helper Functions =====
function weatherCodeToEmoji(code){
  const map={0:'☀️',1:'🌤',2:'⛅',3:'☁️',45:'🌫',48:'🌫',51:'🌦',53:'🌦',55:'🌦',56:'🌧',57:'🌧',61:'🌧',63:'🌧',65:'🌧',66:'❄️',67:'❄️',71:'❄️',73:'❄️',75:'❄️',77:'❄️',80:'🌦',81:'🌧',82:'🌧',85:'❄️',86:'❄️',95:'⛈',96:'⛈',99:'⛈'};
  return map[code]||'❓';
}
function convertTemp(t){return unitC?t:(t*9/5)+32;}
function formatTime(t){const d=new Date(t); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});}
function moonPhaseEmoji(phase){
  if(phase<0.03||phase>0.97) return '🌑';
  if(phase<0.22) return '🌒';
  if(phase<0.28) return '🌓';
  if(phase<0.47) return '🌔';
  if(phase<0.53) return '🌕';
  if(phase<0.72) return '🌖';
  if(phase<0.78) return '🌗';
  return '🌘';
}

// ===== Fetch Data =====
async function fetchWeather(city){
  // Geocoding
  const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${city}`);
  const geoData = await geoRes.json();
  if(!geoData[0]) { alert('City not found'); return; }
  const lat = geoData[0].lat;
  const lon = geoData[0].lon;

  // Open-Meteo forecast
  const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,weathercode,sunrise,sunset,moon_phase&timezone=auto`);
  const weatherData = await weatherRes.json();

  // AQI (World Air Quality API)
  let aqiText = 'N/A';
  try{
    const aqiRes = await fetch(`https://api.waqi.info/feed/geo:${lat};${lon}/?token=demo`);
    const aqiData = await aqiRes.json();
    if(aqiData.status==='ok') aqiText=`AQI: ${aqiData.data.aqi} (${aqiData.data.dominentpol})`;
  }catch(e){}

  lastData = {weatherData, lat, lon, city, aqiText};
  updateDisplay(lastData);
}

// ===== Update Display =====
function updateDisplay({weatherData, lat, lon, city, aqiText}){
  const cw = weatherData.current_weather;
  const daily = weatherData.daily;

  // Current Weather
  document.getElementById('currentWeather').innerHTML = `
    <h2>${city}</h2>
    <div>${weatherCodeToEmoji(cw.weathercode)} ${convertTemp(cw.temperature).toFixed(1)}°${unitC?'C':'F'}</div>
    <div>Wind: ${cw.windspeed} km/h</div>
  `;

  // Forecast
  const forecastDiv = document.getElementById('forecast');
  forecastDiv.innerHTML = '';
  for(let i=0;i<daily.time.length;i++){
    const day = daily.time[i];
    const icon = weatherCodeToEmoji(daily.weathercode[i]);
    forecastDiv.innerHTML += `
      <div class="forecast-day">
        <div>${day}</div>
        <div>${icon}</div>
        <div>${convertTemp(daily.temperature_2m_max[i]).toFixed(1)}° / ${convertTemp(daily.temperature_2m_min[i]).toFixed(1)}°</div>
      </div>`;
  }

  // Sunrise/Sunset & Moon
  document.getElementById('sunMoonCard').innerHTML = `
    <h4>🌞 Sun & 🌙 Moon</h4>
    Sunrise: ${formatTime(daily.sunrise[0])}<br>
    Sunset: ${formatTime(daily.sunset[0])}<br>
    Moon: ${moonPhaseEmoji(daily.moon_phase[0])} (${(daily.moon_phase[0]*100).toFixed(0)}%)
  `;

  // AQI
  document.getElementById('aqiCard').innerHTML = `<h4>Air Quality</h4>${aqiText}`;

  // Map
  map.setView([lat, lon], 8);
}

// ===== Search =====
document.getElementById('searchBtn').addEventListener('click', ()=>{
  const city = document.getElementById('cityInput').value;
  if(city) fetchWeather(city);
});

// Default city
fetchWeather('New York');
</script>
</body>
</html>
